<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIA --> Kotlin converter</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f6; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: 50px auto; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1); }
        h1 { color: #00796b; text-align: center; margin-bottom: 30px; }
        .input-group { margin-bottom: 20px; border: 1px solid #ccc; padding: 15px; border-radius: 8px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #004d40; }
        input[type="file"], input[type="text"] { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        button { background-color: #00796b; color: white; padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; width: 100%; font-size: 16px; transition: background-color 0.3s; }
        button:hover { background-color: #004d40; }
        #log-output { background-color: #e8f5e9; border: 1px solid #c8e6c9; padding: 15px; border-radius: 8px; white-space: pre-wrap; margin-top: 20px; min-height: 100px; }
    </style>
</head>
<body>

<div class="container">
    <h1>AIA --> Kotlin converter</h1>

    <div class="input-group">
        <label for="aiaFile">1. Choose the aia file (.aia)</label>
        <input type="file" id="aiaFile" accept=".aia" required>
        <small>A aia file is a AI2 project</small>
    </div>

    <div class="input-group">
        <label for="projectName">2. Android name project</label>
        <input type="text" id="projectName" value="MonProjetKotlin" required>
    </div>

    <button onclick="startConversion()">Convert</button>

    <div id="log-output">
        Statut de la conversion : Prêt.
    </div>
</div>

<script>
/**
 * NOTE TECHNIQUE :
 * Pour une vraie conversion, le code ci-dessous (la fonction startConversion)
 * devrait envoyer le fichier AIA à un serveur (back-end) pour un traitement lourd :
 * 1. Décompression du ZIP (AIA).
 * 2. Parsing du fichier .scm (Layout).
 * 3. Parsing du fichier .bky (Blocs XML).
 * 4. Transpilation des blocs en Kotlin.
 * 5. Création de la structure Android Studio (XML, Kotlin, Gradle, Assets).
 * 6. Compression en fichier ZIP final.
 *
 * Le script ci-dessous SIMULE ces étapes pour illustrer la maquette frontale.
 */
function startConversion() {
    const fileInput = document.getElementById('aiaFile');
    const projectName = document.getElementById('projectName').value.trim() || 'ConvertedApp';
    const logOutput = document.getElementById('log-output');
    const file = fileInput.files[0];

    logOutput.textContent = 'Statut de la conversion : Démarrage...';

    if (!file) {
        logOutput.textContent += '\nERREUR : Veuillez sélectionner un fichier .aia.';
        return;
    }

    logOutput.textContent = `Statut de la conversion : Lecture de "${file.name}" et encodage en Base64...`;

    // Utilisation de FileReader pour lire le contenu du fichier
    const reader = new FileReader();

    reader.onload = async function(event) {
        // Le résultat est le contenu du fichier encodé en Base64 (après le préfixe)
        const base64Aia = event.target.result.split(',')[1];
        
        logOutput.textContent += '\n[OK] Fichier encodé. Envoi à la fonction Netlify...';
        
        try {
            // --- Appel à la fonction Netlify ---
            const response = await fetch('/.netlify/functions/convert', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    file: base64Aia, // Le contenu Base64 du fichier AIA
                    projectName: projectName
                }),
            });
            // ------------------------------------

            if (!response.ok) {
                // Tente de lire le message d'erreur du backend
                const errorData = await response.json().catch(() => ({ error: 'Erreur inconnue du serveur.' }));
                throw new Error(`Erreur Netlify Function : ${errorData.error || response.statusText}`);
            }

            // Si la conversion réussit (statut 200)
            logOutput.textContent += '\n✅ CONVERSION TERMINÉE ! Le fichier ZIP est généré.';
            
            // --- Déclenchement du téléchargement ---
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${projectName}.zip`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);
            // ------------------------------------

        } catch (error) {
            logOutput.textContent += `\n❌ ÉCHEC DE LA CONVERSION : ${error.message}`;
            console.error(error);
        }
    };

    // Lecture du fichier comme une URL de données (Base64)
    reader.readAsDataURL(file);
}
</script>

</body>
</html>
